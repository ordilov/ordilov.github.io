<!DOCTYPE html><html><head><title>Ordinary</title><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><meta name="description" content="Blog"/><link rel="icon" href="/favicon.ico"/><meta name="next-head-count" content="5"/><link rel="preload" href="/_next/static/css/f30e95c4ef9a5ce6.css" as="style"/><link rel="stylesheet" href="/_next/static/css/f30e95c4ef9a5ce6.css" data-n-g=""/><link rel="preload" href="/_next/static/css/b8560289fc67afa8.css" as="style"/><link rel="stylesheet" href="/_next/static/css/b8560289fc67afa8.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-fd1bc4a65a80e5c8.js" defer=""></script><script src="/_next/static/chunks/framework-5f4595e5518b5600.js" defer=""></script><script src="/_next/static/chunks/main-a054bbf31fb90f6a.js" defer=""></script><script src="/_next/static/chunks/pages/_app-10d16e51767f2eb7.js" defer=""></script><script src="/_next/static/chunks/132-c8ad25a4bdd62a00.js" defer=""></script><script src="/_next/static/chunks/pages/posts/%5Bid%5D-4c91ca1952ea948f.js" defer=""></script><script src="/_next/static/W6bEAFkN1Di57f3HkviIH/_buildManifest.js" defer=""></script><script src="/_next/static/W6bEAFkN1Di57f3HkviIH/_ssgManifest.js" defer=""></script><script src="/_next/static/W6bEAFkN1Di57f3HkviIH/_middlewareManifest.js" defer=""></script></head><body><div id="__next" data-reactroot=""><div class="Home_container__97eC3"><div class="Header_header__ubBbX"><div class="Header_headerLeft__gJBl3"><a href="/">Ordinary</a></div><div class="Header_headerRight__uflv6"><a href="/about">About</a></div></div><article class="Post_container__qv178"><div class="Post_head__hU8yK"><h1 class="Post_title__MJ8Hr">Spring Filter 내부 Exception</h1><div class="Post_meta__TGwfg"><img src="/profile.png" class="Post_avatar__KIFLy" alt="profile"/><div class="Post_profile__wwScp">ordilov /<!-- --> <!-- -->3/7/202</div></div></div><p class="MDX_Paragraph__xqVvo">@RestControllerAdvice로 에러를 전역처리하는데 filter 내부에서 에러는 처리되지 않았습니다.
이 경우 처리를 위해서 겪을 수 있는 문제점들이 있습니다.</p>
<div style="--size:18pt" class="MDX_Heading__T63mn">AuthenticationEntryPoint</div>
<p class="MDX_Paragraph__xqVvo">인증되지 않은 에러인 401 에러인 경우 필터를 거치고 AuthenticationEntryPoint 구현체에서 에러가 처리됩니다.
이 인터페이스를 구현하고 commence 메서드를 오버라이드하면 커스텀 처리가 가능해집니다.</p>
<pre><code class="hljs language-java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title hljs-class">RestAuthenticationEntryPoint</span> <span class="hljs-keyword">implements</span> <span class="hljs-title hljs-class">AuthenticationEntryPoint</span> {

  <span class="hljs-meta">@Override</span>
  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title hljs-function">commence</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response,
      AuthenticationException e)</span> <span class="hljs-keyword">throws</span> IOException {
    log.error(<span class="hljs-string">&quot;잘못된 인증 요청이 들어왔습니다. Message - {}&quot;</span>, e.getMessage());

    <span class="hljs-type">ErrorCode</span> <span class="hljs-variable">errorCode</span> <span class="hljs-operator">=</span> (ErrorCode) request.getAttribute(<span class="hljs-string">&quot;errorCode&quot;</span>);
    <span class="hljs-keyword">if</span> (errorCode == <span class="hljs-literal">null</span>) {
      errorCode = ErrorCode.UNAUTHORIZED;
    }

    <span class="hljs-type">ObjectMapper</span> <span class="hljs-variable">mapper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title hljs-class">ObjectMapper</span>();
    <span class="hljs-type">String</span> <span class="hljs-variable">error</span> <span class="hljs-operator">=</span> mapper.writeValueAsString(CommonResponse.fail(errorCode));

    response.setCharacterEncoding(<span class="hljs-string">&quot;UTF-8&quot;</span>);
    response.setStatus(HttpServletResponse.SC_UNAUTHORIZED);
    response.setContentType(MediaType.APPLICATION_JSON_VALUE);
    response.getWriter().write(error);
  }
}
</code></pre>
<div style="--size:18pt" class="MDX_Heading__T63mn">Filter 중간에서 처리</div>
<p class="MDX_Paragraph__xqVvo">Fitler 중간에서 메서드 파리미터로 넘어온 HttpServletResponse를 이용해 중간에 응답을 보낼 수 있습니다.
방법으로는 sendError 메서드를 이용하거나 response에 write 하는 방식으로 중간에 응답을 보내면 됩니다.
하지만 중간에서 처리하는 경우 응답 보낸 response를 다음 filter로 보내면 안됩니다.
응답이 이미 처리된 형태이기 때문에 다음 필터로 넘어가면 에러가 발생합니다.</p>
<pre><code class="hljs language-java">response.sendError(HttpServletResponse.SC_UNAUTHORIZED, <span class="hljs-string">&quot;Unauthorized&quot;</span>);

...

filterChain.doFilter(request, response); <span class="hljs-comment">// 에러 </span>
</code></pre></article></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"metadata":{"layout":"post","title":"Spring Filter 내부 Exception","date":"2022-03-08 00:01:00 +0900","category":"trouble","tags":["trouble"],"keywords":["trouble"],"id":"Filter 내부 Exception"},"mdxSource":{"compiledSource":"/*@jsxRuntime automatic @jsxImportSource react*/\nconst {Fragment: _Fragment, jsx: _jsx, jsxs: _jsxs} = arguments[0];\nconst {useMDXComponents: _provideComponents} = arguments[0];\nfunction MDXContent(props = {}) {\n  const {wrapper: MDXLayout} = Object.assign({}, _provideComponents(), props.components);\n  return MDXLayout ? _jsx(MDXLayout, Object.assign({}, props, {\n    children: _jsx(_createMdxContent, {})\n  })) : _createMdxContent();\n  function _createMdxContent() {\n    const _components = Object.assign({\n      p: \"p\",\n      h3: \"h3\",\n      pre: \"pre\",\n      code: \"code\",\n      span: \"span\"\n    }, _provideComponents(), props.components);\n    return _jsxs(_Fragment, {\n      children: [_jsx(_components.p, {\n        children: \"@RestControllerAdvice로 에러를 전역처리하는데 filter 내부에서 에러는 처리되지 않았습니다.\\n이 경우 처리를 위해서 겪을 수 있는 문제점들이 있습니다.\"\n      }), \"\\n\", _jsx(_components.h3, {\n        children: \"AuthenticationEntryPoint\"\n      }), \"\\n\", _jsx(_components.p, {\n        children: \"인증되지 않은 에러인 401 에러인 경우 필터를 거치고 AuthenticationEntryPoint 구현체에서 에러가 처리됩니다.\\n이 인터페이스를 구현하고 commence 메서드를 오버라이드하면 커스텀 처리가 가능해집니다.\"\n      }), \"\\n\", _jsx(_components.pre, {\n        children: _jsxs(_components.code, {\n          className: \"hljs language-java\",\n          children: [_jsx(_components.span, {\n            className: \"hljs-keyword\",\n            children: \"public\"\n          }), \" \", _jsx(_components.span, {\n            className: \"hljs-keyword\",\n            children: \"class\"\n          }), \" \", _jsx(_components.span, {\n            className: \"hljs-title hljs-class\",\n            children: \"RestAuthenticationEntryPoint\"\n          }), \" \", _jsx(_components.span, {\n            className: \"hljs-keyword\",\n            children: \"implements\"\n          }), \" \", _jsx(_components.span, {\n            className: \"hljs-title hljs-class\",\n            children: \"AuthenticationEntryPoint\"\n          }), \" {\\n\\n  \", _jsx(_components.span, {\n            className: \"hljs-meta\",\n            children: \"@Override\"\n          }), \"\\n  \", _jsx(_components.span, {\n            className: \"hljs-keyword\",\n            children: \"public\"\n          }), \" \", _jsx(_components.span, {\n            className: \"hljs-keyword\",\n            children: \"void\"\n          }), \" \", _jsx(_components.span, {\n            className: \"hljs-title hljs-function\",\n            children: \"commence\"\n          }), _jsx(_components.span, {\n            className: \"hljs-params\",\n            children: \"(HttpServletRequest request, HttpServletResponse response,\\n      AuthenticationException e)\"\n          }), \" \", _jsx(_components.span, {\n            className: \"hljs-keyword\",\n            children: \"throws\"\n          }), \" IOException {\\n    log.error(\", _jsx(_components.span, {\n            className: \"hljs-string\",\n            children: \"\\\"잘못된 인증 요청이 들어왔습니다. Message - {}\\\"\"\n          }), \", e.getMessage());\\n\\n    \", _jsx(_components.span, {\n            className: \"hljs-type\",\n            children: \"ErrorCode\"\n          }), \" \", _jsx(_components.span, {\n            className: \"hljs-variable\",\n            children: \"errorCode\"\n          }), \" \", _jsx(_components.span, {\n            className: \"hljs-operator\",\n            children: \"=\"\n          }), \" (ErrorCode) request.getAttribute(\", _jsx(_components.span, {\n            className: \"hljs-string\",\n            children: \"\\\"errorCode\\\"\"\n          }), \");\\n    \", _jsx(_components.span, {\n            className: \"hljs-keyword\",\n            children: \"if\"\n          }), \" (errorCode == \", _jsx(_components.span, {\n            className: \"hljs-literal\",\n            children: \"null\"\n          }), \") {\\n      errorCode = ErrorCode.UNAUTHORIZED;\\n    }\\n\\n    \", _jsx(_components.span, {\n            className: \"hljs-type\",\n            children: \"ObjectMapper\"\n          }), \" \", _jsx(_components.span, {\n            className: \"hljs-variable\",\n            children: \"mapper\"\n          }), \" \", _jsx(_components.span, {\n            className: \"hljs-operator\",\n            children: \"=\"\n          }), \" \", _jsx(_components.span, {\n            className: \"hljs-keyword\",\n            children: \"new\"\n          }), \" \", _jsx(_components.span, {\n            className: \"hljs-title hljs-class\",\n            children: \"ObjectMapper\"\n          }), \"();\\n    \", _jsx(_components.span, {\n            className: \"hljs-type\",\n            children: \"String\"\n          }), \" \", _jsx(_components.span, {\n            className: \"hljs-variable\",\n            children: \"error\"\n          }), \" \", _jsx(_components.span, {\n            className: \"hljs-operator\",\n            children: \"=\"\n          }), \" mapper.writeValueAsString(CommonResponse.fail(errorCode));\\n\\n    response.setCharacterEncoding(\", _jsx(_components.span, {\n            className: \"hljs-string\",\n            children: \"\\\"UTF-8\\\"\"\n          }), \");\\n    response.setStatus(HttpServletResponse.SC_UNAUTHORIZED);\\n    response.setContentType(MediaType.APPLICATION_JSON_VALUE);\\n    response.getWriter().write(error);\\n  }\\n}\\n\"]\n        })\n      }), \"\\n\", _jsx(_components.h3, {\n        children: \"Filter 중간에서 처리\"\n      }), \"\\n\", _jsx(_components.p, {\n        children: \"Fitler 중간에서 메서드 파리미터로 넘어온 HttpServletResponse를 이용해 중간에 응답을 보낼 수 있습니다.\\n방법으로는 sendError 메서드를 이용하거나 response에 write 하는 방식으로 중간에 응답을 보내면 됩니다.\\n하지만 중간에서 처리하는 경우 응답 보낸 response를 다음 filter로 보내면 안됩니다.\\n응답이 이미 처리된 형태이기 때문에 다음 필터로 넘어가면 에러가 발생합니다.\"\n      }), \"\\n\", _jsx(_components.pre, {\n        children: _jsxs(_components.code, {\n          className: \"hljs language-java\",\n          children: [\"response.sendError(HttpServletResponse.SC_UNAUTHORIZED, \", _jsx(_components.span, {\n            className: \"hljs-string\",\n            children: \"\\\"Unauthorized\\\"\"\n          }), \");\\n\\n...\\n\\nfilterChain.doFilter(request, response); \", _jsx(_components.span, {\n            className: \"hljs-comment\",\n            children: \"// 에러 \"\n          }), \"\\n\"]\n        })\n      })]\n    });\n  }\n}\nreturn {\n  default: MDXContent\n};\n","frontmatter":{},"scope":{}}},"__N_SSG":true},"page":"/posts/[id]","query":{"id":"Filter 내부 Exception"},"buildId":"W6bEAFkN1Di57f3HkviIH","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>