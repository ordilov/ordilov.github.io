<!DOCTYPE html><html><head><title class="jsx-11a0cb94398737f0">Ordinary</title><meta charSet="utf-8" class="jsx-11a0cb94398737f0"/><meta name="viewport" content="width=device-width, initial-scale=1" class="jsx-11a0cb94398737f0"/><meta name="description" content="Blog" class="jsx-11a0cb94398737f0"/><link rel="icon" href="/favicon.ico" class="jsx-11a0cb94398737f0"/><meta name="next-head-count" content="5"/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-9b312e20a4e32339.js" defer=""></script><script src="/_next/static/chunks/framework-82797a600c079ab5.js" defer=""></script><script src="/_next/static/chunks/main-a054bbf31fb90f6a.js" defer=""></script><script src="/_next/static/chunks/pages/_app-ff0c62947eb4af1a.js" defer=""></script><script src="/_next/static/chunks/pages/posts/%5Bid%5D-e50a7c1f288c3a66.js" defer=""></script><script src="/_next/static/B8NI0PSFXqUfoDDx0IWnS/_buildManifest.js" defer=""></script><script src="/_next/static/B8NI0PSFXqUfoDDx0IWnS/_ssgManifest.js" defer=""></script><script src="/_next/static/B8NI0PSFXqUfoDDx0IWnS/_middlewareManifest.js" defer=""></script><style id="__jsx-11a0cb94398737f0">header.jsx-11a0cb94398737f0{display:grid;
color:#0070f3;
background-color:#1e1e1e;
padding:20px;
border-bottom:1px solid #e5e5e5;
grid-template-columns:1fr 1fr;
grid-template-rows:100px}
.headerLeft.jsx-11a0cb94398737f0{font-size:24pt;
font-family:'Source Sans Pro', sans-serif;
display:-webkit-box;
display:-webkit-flex;
display:-ms-flexbox;
display:flex;
-webkit-align-items:center;
-webkit-box-align:center;
-ms-flex-align:center;
align-items:center;
-webkit-text-decoration:none;
text-decoration:none}
.headerRight.jsx-11a0cb94398737f0{display:-webkit-box;
display:-webkit-flex;
display:-ms-flexbox;
display:flex;
-webkit-align-items:center;
-webkit-box-align:center;
-ms-flex-align:center;
align-items:center;
-webkit-flex-direction:row-reverse;
-ms-flex-direction:row-reverse;
flex-direction:row-reverse}
@media (min-width:720px) {header.jsx-11a0cb94398737f0{max-width:50rem;
padding:0 2rem;
margin:0 auto}}</style><style id="__jsx-2786876435">a.jsx-2786876435{display:block;
margin-left:0px;
padding-left:0.3rem;
padding-top:0.5rem;
padding-bottom:0.5rem;
width:140px;
-webkit-text-decoration:none;
text-decoration:none;
color:#FFF;
font-size:8pt;
border-bottom:1px solid #ccc}
[aria-current].jsx-2786876435:not([aria-current="false"]){font-weight:bold;
color:red}</style><style id="__jsx-d3a8789621931ffd">aside.jsx-d3a8789621931ffd{position:absolute;
right:0;
width:200px;
height:100%}
nav.jsx-d3a8789621931ffd{top:200px;
padding:0 0 0 10px;
display:inline-block;
position:-webkit-sticky;
position:sticky}
ul.jsx-d3a8789621931ffd{list-style:none}
@media (max-width:1080px) {aside.jsx-d3a8789621931ffd{visibility:hidden}}</style><style id="__jsx-44892c5bd5256dd3">article.jsx-44892c5bd5256dd3{display:block;
margin:0 auto;
padding:0 1rem}
@media (max-width:800px) {aside.jsx-44892c5bd5256dd3{position:static;
height:auto}}
.title.jsx-44892c5bd5256dd3{font-size:30pt;
margin-bottom:5px}
.head.jsx-44892c5bd5256dd3{margin-bottom:2rem}
.avatar.jsx-44892c5bd5256dd3{margin-right:0.5rem}
.meta.jsx-44892c5bd5256dd3{display:-webkit-box;
display:-webkit-flex;
display:-ms-flexbox;
display:flex;
margin-right:0.5rem}
.profile.jsx-44892c5bd5256dd3{color:#A0AEC0;
line-height:1.5;
margin-right:0.5rem}
.container.jsx-44892c5bd5256dd3{width:100%;
max-width:700px;
margin:0 auto;
line-height:1.625}</style><style id="__jsx-54d2412a35c4003a">.github.jsx-54d2412a35c4003a{text-align:center}</style><style id="__jsx-bf1060902d5987dc">footer.jsx-bf1060902d5987dc{height:6rem;
padding:0 2rem;
text-align:center;
margin:0 auto;
display:grid;
grid-template-columns:1fr 1fr}
span.jsx-bf1060902d5987dc{padding:2rem 0}
@media (min-width:720px) {footer.jsx-bf1060902d5987dc{max-width:50rem;
padding:0 2rem;
margin:0 auto}}</style><style id="__jsx-2037d33799e7fd9a">*{color:white;
box-sizing:border-box}
html, body{padding:0;
margin:0;
font-family:-apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Oxygen, Ubuntu, Cantarell, Fira Sans, Droid Sans, Helvetica Neue, sans-serif;
background:#1e1e1e}
a{color:inherit;
-webkit-text-decoration:none;
text-decoration:none}
main{position:relative;
background:#1e1e1e;
min-height:100vh;
height:100%;
padding:4rem 0;
-webkit-align-items:center;
-webkit-box-align:center;
-ms-flex-align:center;
align-items:center}
strong{color:#a964a7}
code{color:#3fd0c0;
font-weight:bold;
font-family:-apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Oxygen, Ubuntu, Cantarell, Fira Sans, Droid Sans, Helvetica Neue, sans-serif}
blockquote{border:3px solid #27a9e3;
margin-left:0;
margin-right:0;
padding-left:20px;
padding-right:20px;
border-left:12px solid #27a9e3;
border-radius:5px}
article{position:relative}
@media (min-width:720px) {main{max-width:70rem;
padding:0 2rem;
margin:0 auto}}
.hljs{font-size:0.9rem;
background:#333;
font-family:SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
display:block;
color:#fff;
border-radius:5px;
overflow:auto;
padding:1em;
margin:0.6em}
.hljs-doctag, .hljs-meta-keyword, .hljs-name, .hljs-strong{font-weight:bold}
.hljs-code, .hljs-emphasis{font-style:italic}
.hljs-section, .hljs-tag{color:#62c8f3}
.hljs-selector-class, .hljs-selector-id, .hljs-template-variable, .hljs-variable{color:#ade5fc}
.hljs-meta-string, .hljs-string{color:#a2fca2}
.hljs-attr, .hljs-quote, .hljs-selector-attr{color:#7bd694}
.hljs-tag .hljs-attr{color:inherit}
.hljs-attribute, .hljs-title, .hljs-type{color:#ffa}
.hljs-number, .hljs-symbol{color:#d36363}
.hljs-bullet, .hljs-template-tag{color:#b8d8a2}
.hljs-built_in, .hljs-keyword, .hljs-literal, .hljs-selector-tag{color:#fcc28c}
.hljs-code, .hljs-comment, .hljs-formula{color:#888}
.hljs-link, .hljs-selector-pseudo, .hljs-regexp{color:#c6b4f0}
.hljs-meta{color:#fc9b9b}
.hljs-deletion{background:#fc9b9b;
color:#333}
.hljs-addition{background:#a2fca2;
color:#333}
.hljs-operator, .hljs-params, .hljs-property, .hljs-punctuation{}
.hljs-subst{color:#fff}
.hljs a{color:inherit}
.hljs a:focus, .hljs a:hover{color:inherit;
text-decoration:underline}
.hljs mark{background:#555;
color:inherit}</style></head><body><div id="__next" data-reactroot=""><header class="jsx-11a0cb94398737f0"><div class="jsx-11a0cb94398737f0 headerLeft"><a href="/">Ordinary</a></div><div class="jsx-11a0cb94398737f0 headerRight"><a class="jsx-11a0cb94398737f0" href="/about">About</a></div></header><main><div class="jsx-18cc8619c204c37c"><div class="jsx-44892c5bd5256dd3"><aside class="jsx-d3a8789621931ffd"><nav class="jsx-d3a8789621931ffd"><ul class="jsx-d3a8789621931ffd"><li class="jsx-2786876435"><a href="#Spring 초기에 DB 연결이 안되면" class="jsx-2786876435"> <!-- -->Spring 초기에 DB 연결이 안되면</a></li><li class="jsx-2786876435"><a href="#서버 실행 중간에 DB 연결이 안되면" class="jsx-2786876435"> <!-- -->서버 실행 중간에 DB 연결이 안되면</a></li></ul></nav></aside><article class="jsx-44892c5bd5256dd3 container"><div class="jsx-44892c5bd5256dd3 head"><h1 class="jsx-44892c5bd5256dd3 title">Spring DB 서버가 중단되면</h1><div class="jsx-44892c5bd5256dd3 meta"><img src="/profile.png" alt="profile" class="jsx-44892c5bd5256dd3 avatar"/><div class="jsx-44892c5bd5256dd3 profile">ordilov /<!-- --> <!-- -->2022. 3. 31</div></div></div><div id="Spring 초기에 DB 연결이 안되면"><h2>Spring 초기에 DB 연결이 안되면</h2></div>
<p class=".Paragraph.jsx-c13bd6d988b6c83{line-height:1.625}">JPA와 Hikari CP를 사용하고 있는 경우 DB 서버와 연결이 안되는 경우 서버가 시작되지 않습니다.</p>
<pre><code class="hljs language-javascript"> <span class="hljs-title class_">Error</span> creating bean <span class="hljs-keyword">with</span> name <span class="hljs-string">&#x27;entityManagerFactory&#x27;</span> ..
</code></pre>
<p class=".Paragraph.jsx-c13bd6d988b6c83{line-height:1.625}">Hikari CP 에서 몇 차례 연결 시도를 하고 실패하는 경우 entityManagerFactory 빈을 생성할 때 에러가 발생합니다.</p>
<div id="서버 실행 중간에 DB 연결이 안되면"><h2>서버 실행 중간에 DB 연결이 안되면</h2></div>
<p class=".Paragraph.jsx-c13bd6d988b6c83{line-height:1.625}">테스트를 위해서 실행 중간에 DB 서버를 종료시켰습니다.
서버가 실행되는 중에 DB 연결이 끊기더라도 DB 연결이 필요한 요청이 오기 전까지 확인하지 않았습니다.</p>
<pre><code class="hljs language-css">HikariPool-<span class="hljs-number">1</span> - Failed <span class="hljs-selector-tag">to</span> validate connection com<span class="hljs-selector-class">.mysql</span><span class="hljs-selector-class">.cj</span><span class="hljs-selector-class">.jdbc</span><span class="hljs-selector-class">.ConnectionImpl</span><span class="hljs-keyword">@65ff8761</span>
(No operations allowed after connection closed.).
Possibly consider using a shorter maxLifetime value.
</code></pre>
<p class=".Paragraph.jsx-c13bd6d988b6c83{line-height:1.625}">연결이 다시 들어오면 DB 커넥션 풀에서 연결을 찾는 과정을 반복하고 로그를 남깁니다.
Hikari Pool을 사용하는 경우 위와 같은 로그가 남게 됩니다.
로그 기록을 보면 실패하고 연결을 기간을 두고 10번을 시도한 것을 확인할 수 있었습니다.</p>
<pre><code class="hljs language-csharp">HikariPool<span class="hljs-number">-1</span> - Connection <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> available, request timed <span class="hljs-keyword">out</span> after <span class="hljs-number">30000</span>ms.
</code></pre>
<p class=".Paragraph.jsx-c13bd6d988b6c83{line-height:1.625}">10번이 완료되고 나서 요청 시간이 30000ms 지나서 연결이 안된 것으로 판단한 것을 확인할 수 있습니다.
이때 나오는 30000ms 가 maxLifetime으로 필요에 따라 늘리거나 줄일 수 있습니다.</p>
<pre><code class="hljs language-yaml"><span class="hljs-attr">spring:</span>
    <span class="hljs-attr">datasource:</span>
        <span class="hljs-attr">hikari:</span>
            <span class="hljs-attr">maxLifetime:</span> <span class="hljs-number">30000</span>
</code></pre>
<p class=".Paragraph.jsx-c13bd6d988b6c83{line-height:1.625}">따로 설정하지 않아도 위에서 나온 기본값처럼 30000ms 가 설정됩니다.
중요한 점은 이때 지정하는 maxLifetime은 데이터베이스에 적용된 connection time limit 보다 작아야 합니다.</p>
<pre><code class="hljs language-yaml"><span class="hljs-attr">java.net.ConnectException: Connection refused:</span> <span class="hljs-literal">no</span> <span class="hljs-string">further</span> <span class="hljs-string">information</span>
</code></pre>
<p class=".Paragraph.jsx-c13bd6d988b6c83{line-height:1.625}">최종적으로 확인할 수 있는 에러는 ConnectionException으로 나오게 됩니다.
웹 요청이었다면 방금 거치는 DB 연결이 끊기는지 확인하는 시간까지 다 지난 후에 에러 응답이 나가게 됩니다.</p></article></div></div></main><footer class="jsx-bf1060902d5987dc"><span class="jsx-bf1060902d5987dc"><a href="https://github.com/ordilov" class="jsx-54d2412a35c4003a">Github</a></span><span class="jsx-bf1060902d5987dc">Copyright © Ordilov</span></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"metadata":{"title":"Spring DB 서버가 중단되면","date":"2022-04-01 00:00:01 +0900","category":"backend","tags":["backend"],"keywords":["backend"],"description":"Spring 서버 동작 중 DB와의 연결이 중단되었을 때를 알아봅니다.","id":"Spring db 서버가 중단되면"},"mdxSource":{"compiledSource":"/*@jsxRuntime automatic @jsxImportSource react*/\nconst {Fragment: _Fragment, jsx: _jsx, jsxs: _jsxs} = arguments[0];\nconst {useMDXComponents: _provideComponents} = arguments[0];\nfunction MDXContent(props = {}) {\n  const {wrapper: MDXLayout} = Object.assign({}, _provideComponents(), props.components);\n  return MDXLayout ? _jsx(MDXLayout, Object.assign({}, props, {\n    children: _jsx(_createMdxContent, {})\n  })) : _createMdxContent();\n  function _createMdxContent() {\n    const _components = Object.assign({\n      h2: \"h2\",\n      p: \"p\",\n      pre: \"pre\",\n      code: \"code\",\n      span: \"span\"\n    }, _provideComponents(), props.components);\n    return _jsxs(_Fragment, {\n      children: [_jsx(_components.h2, {\n        children: \"Spring 초기에 DB 연결이 안되면\"\n      }), \"\\n\", _jsx(_components.p, {\n        children: \"JPA와 Hikari CP를 사용하고 있는 경우 DB 서버와 연결이 안되는 경우 서버가 시작되지 않습니다.\"\n      }), \"\\n\", _jsx(_components.pre, {\n        children: _jsxs(_components.code, {\n          className: \"hljs language-javascript\",\n          children: [\" \", _jsx(_components.span, {\n            className: \"hljs-title class_\",\n            children: \"Error\"\n          }), \" creating bean \", _jsx(_components.span, {\n            className: \"hljs-keyword\",\n            children: \"with\"\n          }), \" name \", _jsx(_components.span, {\n            className: \"hljs-string\",\n            children: \"'entityManagerFactory'\"\n          }), \" ..\\n\"]\n        })\n      }), \"\\n\", _jsx(_components.p, {\n        children: \"Hikari CP 에서 몇 차례 연결 시도를 하고 실패하는 경우 entityManagerFactory 빈을 생성할 때 에러가 발생합니다.\"\n      }), \"\\n\", _jsx(_components.h2, {\n        children: \"서버 실행 중간에 DB 연결이 안되면\"\n      }), \"\\n\", _jsx(_components.p, {\n        children: \"테스트를 위해서 실행 중간에 DB 서버를 종료시켰습니다.\\n서버가 실행되는 중에 DB 연결이 끊기더라도 DB 연결이 필요한 요청이 오기 전까지 확인하지 않았습니다.\"\n      }), \"\\n\", _jsx(_components.pre, {\n        children: _jsxs(_components.code, {\n          className: \"hljs language-css\",\n          children: [\"HikariPool-\", _jsx(_components.span, {\n            className: \"hljs-number\",\n            children: \"1\"\n          }), \" - Failed \", _jsx(_components.span, {\n            className: \"hljs-selector-tag\",\n            children: \"to\"\n          }), \" validate connection com\", _jsx(_components.span, {\n            className: \"hljs-selector-class\",\n            children: \".mysql\"\n          }), _jsx(_components.span, {\n            className: \"hljs-selector-class\",\n            children: \".cj\"\n          }), _jsx(_components.span, {\n            className: \"hljs-selector-class\",\n            children: \".jdbc\"\n          }), _jsx(_components.span, {\n            className: \"hljs-selector-class\",\n            children: \".ConnectionImpl\"\n          }), _jsx(_components.span, {\n            className: \"hljs-keyword\",\n            children: \"@65ff8761\"\n          }), \"\\n(No operations allowed after connection closed.).\\nPossibly consider using a shorter maxLifetime value.\\n\"]\n        })\n      }), \"\\n\", _jsx(_components.p, {\n        children: \"연결이 다시 들어오면 DB 커넥션 풀에서 연결을 찾는 과정을 반복하고 로그를 남깁니다.\\nHikari Pool을 사용하는 경우 위와 같은 로그가 남게 됩니다.\\n로그 기록을 보면 실패하고 연결을 기간을 두고 10번을 시도한 것을 확인할 수 있었습니다.\"\n      }), \"\\n\", _jsx(_components.pre, {\n        children: _jsxs(_components.code, {\n          className: \"hljs language-csharp\",\n          children: [\"HikariPool\", _jsx(_components.span, {\n            className: \"hljs-number\",\n            children: \"-1\"\n          }), \" - Connection \", _jsx(_components.span, {\n            className: \"hljs-keyword\",\n            children: \"is\"\n          }), \" \", _jsx(_components.span, {\n            className: \"hljs-keyword\",\n            children: \"not\"\n          }), \" available, request timed \", _jsx(_components.span, {\n            className: \"hljs-keyword\",\n            children: \"out\"\n          }), \" after \", _jsx(_components.span, {\n            className: \"hljs-number\",\n            children: \"30000\"\n          }), \"ms.\\n\"]\n        })\n      }), \"\\n\", _jsx(_components.p, {\n        children: \"10번이 완료되고 나서 요청 시간이 30000ms 지나서 연결이 안된 것으로 판단한 것을 확인할 수 있습니다.\\n이때 나오는 30000ms 가 maxLifetime으로 필요에 따라 늘리거나 줄일 수 있습니다.\"\n      }), \"\\n\", _jsx(_components.pre, {\n        children: _jsxs(_components.code, {\n          className: \"hljs language-yaml\",\n          children: [_jsx(_components.span, {\n            className: \"hljs-attr\",\n            children: \"spring:\"\n          }), \"\\n    \", _jsx(_components.span, {\n            className: \"hljs-attr\",\n            children: \"datasource:\"\n          }), \"\\n        \", _jsx(_components.span, {\n            className: \"hljs-attr\",\n            children: \"hikari:\"\n          }), \"\\n            \", _jsx(_components.span, {\n            className: \"hljs-attr\",\n            children: \"maxLifetime:\"\n          }), \" \", _jsx(_components.span, {\n            className: \"hljs-number\",\n            children: \"30000\"\n          }), \"\\n\"]\n        })\n      }), \"\\n\", _jsx(_components.p, {\n        children: \"따로 설정하지 않아도 위에서 나온 기본값처럼 30000ms 가 설정됩니다.\\n중요한 점은 이때 지정하는 maxLifetime은 데이터베이스에 적용된 connection time limit 보다 작아야 합니다.\"\n      }), \"\\n\", _jsx(_components.pre, {\n        children: _jsxs(_components.code, {\n          className: \"hljs language-yaml\",\n          children: [_jsx(_components.span, {\n            className: \"hljs-attr\",\n            children: \"java.net.ConnectException: Connection refused:\"\n          }), \" \", _jsx(_components.span, {\n            className: \"hljs-literal\",\n            children: \"no\"\n          }), \" \", _jsx(_components.span, {\n            className: \"hljs-string\",\n            children: \"further\"\n          }), \" \", _jsx(_components.span, {\n            className: \"hljs-string\",\n            children: \"information\"\n          }), \"\\n\"]\n        })\n      }), \"\\n\", _jsx(_components.p, {\n        children: \"최종적으로 확인할 수 있는 에러는 ConnectionException으로 나오게 됩니다.\\n웹 요청이었다면 방금 거치는 DB 연결이 끊기는지 확인하는 시간까지 다 지난 후에 에러 응답이 나가게 됩니다.\"\n      })]\n    });\n  }\n}\nreturn {\n  default: MDXContent\n};\n","frontmatter":{},"scope":{}}},"__N_SSG":true},"page":"/posts/[id]","query":{"id":"Spring db 서버가 중단되면"},"buildId":"B8NI0PSFXqUfoDDx0IWnS","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>