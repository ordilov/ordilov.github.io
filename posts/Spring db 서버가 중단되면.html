<!DOCTYPE html><html><head><title>Ordinary</title><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><meta name="description" content="Blog"/><link rel="icon" href="/favicon.ico"/><meta name="next-head-count" content="5"/><link rel="preload" href="/_next/static/css/765fb4fbab0b233a.css" as="style"/><link rel="stylesheet" href="/_next/static/css/765fb4fbab0b233a.css" data-n-g=""/><link rel="preload" href="/_next/static/css/1afd36a183130af5.css" as="style"/><link rel="stylesheet" href="/_next/static/css/1afd36a183130af5.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-9b312e20a4e32339.js" defer=""></script><script src="/_next/static/chunks/framework-82797a600c079ab5.js" defer=""></script><script src="/_next/static/chunks/main-a054bbf31fb90f6a.js" defer=""></script><script src="/_next/static/chunks/pages/_app-46629148a08166c1.js" defer=""></script><script src="/_next/static/chunks/pages/posts/%5Bid%5D-7c59f9808c8355a5.js" defer=""></script><script src="/_next/static/OHndlubwgpGIpyme6ZXhY/_buildManifest.js" defer=""></script><script src="/_next/static/OHndlubwgpGIpyme6ZXhY/_ssgManifest.js" defer=""></script><script src="/_next/static/OHndlubwgpGIpyme6ZXhY/_middlewareManifest.js" defer=""></script><style id="__jsx-2786876435">a.jsx-2786876435{display:block;
margin-left:0px;
padding-left:0.3rem;
padding-top:0.5rem;
padding-bottom:0.5rem;
width:140px;
-webkit-text-decoration:none;
text-decoration:none;
color:#FFF;
font-size:8pt;
border-bottom:1px solid #ccc}
[aria-current].jsx-2786876435:not([aria-current="false"]){font-weight:bold;
color:red}</style><style id="__jsx-3b70050e699e9af6">aside.jsx-3b70050e699e9af6{position:absolute;
right:0;
width:200px;
height:100%}
nav.jsx-3b70050e699e9af6{top:200px;
padding:0 0 0 10px;
display:inline-block;
position:-webkit-sticky;
position:sticky}
@media (max-width:1080px) {aside.jsx-3b70050e699e9af6{visibility:hidden}}</style><style id="__jsx-18f58d3410611438">article.jsx-18f58d3410611438{display:block;
margin:0 auto;
padding:0 1rem}
@media (max-width:800px) {aside.jsx-18f58d3410611438{position:static;
height:auto}}</style><style id="__jsx-76612a042023d019">footer.jsx-76612a042023d019{background-color:#1e1e1e;
padding:20px;
text-align:center}</style><style id="__jsx-853d05b23ef572e2">.container.jsx-853d05b23ef572e2{position:relative;
padding:0 2rem}
@media (min-width:900px) {.container.jsx-853d05b23ef572e2{position:relative;
max-width:1080px;
padding:0 2rem;
margin-left:auto;
margin-right:auto}}</style></head><body><div id="__next" data-reactroot=""><div class="jsx-853d05b23ef572e2 container"><div class="Header_header__ubBbX"><div class="Header_headerLeft__gJBl3"><a href="/">Ordinary</a></div><div class="Header_headerRight__uflv6"><a href="/about">About</a></div></div><div class="jsx-18f58d3410611438"><aside class="jsx-3b70050e699e9af6"><nav class="jsx-3b70050e699e9af6"><a href="#Spring 초기에 DB 연결이 안되면" class="jsx-2786876435"> <!-- -->Spring 초기에 DB 연결이 안되면</a><a href="#서버 실행 중간에 DB 연결이 안되면" class="jsx-2786876435"> <!-- -->서버 실행 중간에 DB 연결이 안되면</a></nav></aside><article class="jsx-18f58d3410611438 Post_container__qv178"><div class="jsx-18f58d3410611438 Post_head__hU8yK"><h1 class="jsx-18f58d3410611438 Post_title__MJ8Hr">Spring DB 서버가 중단되면</h1><div class="jsx-18f58d3410611438 Post_meta__TGwfg"><img src="/profile.png" alt="profile" class="jsx-18f58d3410611438 Post_avatar__KIFLy"/><div class="jsx-18f58d3410611438 Post_profile__wwScp">ordilov /<!-- --> <!-- -->2022. 3. 31</div></div></div><div id="Spring 초기에 DB 연결이 안되면"><h2>Spring 초기에 DB 연결이 안되면</h2> </div>
<p class="MDX_Paragraph__xqVvo">JPA와 Hikari CP를 사용하고 있는 경우 DB 서버와 연결이 안되는 경우 서버가 시작되지 않습니다.</p>
<pre><code class="hljs language-javascript"> <span class="hljs-title class_">Error</span> creating bean <span class="hljs-keyword">with</span> name <span class="hljs-string">&#x27;entityManagerFactory&#x27;</span> ..
</code></pre>
<p class="MDX_Paragraph__xqVvo">Hikari CP 에서 몇 차례 연결 시도를 하고 실패하는 경우 entityManagerFactory 빈을 생성할 때 에러가 발생합니다.</p>
<div id="서버 실행 중간에 DB 연결이 안되면"><h2>서버 실행 중간에 DB 연결이 안되면</h2> </div>
<p class="MDX_Paragraph__xqVvo">테스트를 위해서 실행 중간에 DB 서버를 종료시켰습니다.
서버가 실행되는 중에 DB 연결이 끊기더라도 DB 연결이 필요한 요청이 오기 전까지 확인하지 않았습니다.</p>
<pre><code class="hljs language-css">HikariPool-<span class="hljs-number">1</span> - Failed <span class="hljs-selector-tag">to</span> validate connection com<span class="hljs-selector-class">.mysql</span><span class="hljs-selector-class">.cj</span><span class="hljs-selector-class">.jdbc</span><span class="hljs-selector-class">.ConnectionImpl</span><span class="hljs-keyword">@65ff8761</span>
(No operations allowed after connection closed.).
Possibly consider using a shorter maxLifetime value.
</code></pre>
<p class="MDX_Paragraph__xqVvo">연결이 다시 들어오면 DB 커넥션 풀에서 연결을 찾는 과정을 반복하고 로그를 남깁니다.
Hikari Pool을 사용하는 경우 위와 같은 로그가 남게 됩니다.
로그 기록을 보면 실패하고 연결을 기간을 두고 10번을 시도한 것을 확인할 수 있었습니다.</p>
<pre><code class="hljs language-csharp">HikariPool<span class="hljs-number">-1</span> - Connection <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> available, request timed <span class="hljs-keyword">out</span> after <span class="hljs-number">30000</span>ms.
</code></pre>
<p class="MDX_Paragraph__xqVvo">10번이 완료되고 나서 요청 시간이 30000ms 지나서 연결이 안된 것으로 판단한 것을 확인할 수 있습니다.
이때 나오는 30000ms 가 maxLifetime으로 필요에 따라 늘리거나 줄일 수 있습니다.</p>
<pre><code class="hljs language-yaml"><span class="hljs-attr">spring:</span>
    <span class="hljs-attr">datasource:</span>
        <span class="hljs-attr">hikari:</span>
            <span class="hljs-attr">maxLifetime:</span> <span class="hljs-number">30000</span>
</code></pre>
<p class="MDX_Paragraph__xqVvo">따로 설정하지 않아도 위에서 나온 기본값처럼 30000ms 가 설정됩니다.
중요한 점은 이때 지정하는 maxLifetime은 데이터베이스에 적용된 connection time limit 보다 작아야 합니다.</p>
<pre><code class="hljs language-yaml"><span class="hljs-attr">java.net.ConnectException: Connection refused:</span> <span class="hljs-literal">no</span> <span class="hljs-string">further</span> <span class="hljs-string">information</span>
</code></pre>
<p class="MDX_Paragraph__xqVvo">최종적으로 확인할 수 있는 에러는 ConnectionException으로 나오게 됩니다.
웹 요청이었다면 방금 거치는 DB 연결이 끊기는지 확인하는 시간까지 다 지난 후에 에러 응답이 나가게 됩니다.</p></article></div><footer class="jsx-76612a042023d019"></footer></div><footer class="jsx-76612a042023d019"></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"metadata":{"title":"Spring DB 서버가 중단되면","date":"2022-04-01 00:00:01 +0900","category":"backend","tags":["backend"],"keywords":["backend"],"id":"Spring db 서버가 중단되면"},"mdxSource":{"compiledSource":"/*@jsxRuntime automatic @jsxImportSource react*/\nconst {Fragment: _Fragment, jsx: _jsx, jsxs: _jsxs} = arguments[0];\nconst {useMDXComponents: _provideComponents} = arguments[0];\nfunction MDXContent(props = {}) {\n  const {wrapper: MDXLayout} = Object.assign({}, _provideComponents(), props.components);\n  return MDXLayout ? _jsx(MDXLayout, Object.assign({}, props, {\n    children: _jsx(_createMdxContent, {})\n  })) : _createMdxContent();\n  function _createMdxContent() {\n    const _components = Object.assign({\n      h2: \"h2\",\n      p: \"p\",\n      pre: \"pre\",\n      code: \"code\",\n      span: \"span\"\n    }, _provideComponents(), props.components);\n    return _jsxs(_Fragment, {\n      children: [_jsx(_components.h2, {\n        children: \"Spring 초기에 DB 연결이 안되면\"\n      }), \"\\n\", _jsx(_components.p, {\n        children: \"JPA와 Hikari CP를 사용하고 있는 경우 DB 서버와 연결이 안되는 경우 서버가 시작되지 않습니다.\"\n      }), \"\\n\", _jsx(_components.pre, {\n        children: _jsxs(_components.code, {\n          className: \"hljs language-javascript\",\n          children: [\" \", _jsx(_components.span, {\n            className: \"hljs-title class_\",\n            children: \"Error\"\n          }), \" creating bean \", _jsx(_components.span, {\n            className: \"hljs-keyword\",\n            children: \"with\"\n          }), \" name \", _jsx(_components.span, {\n            className: \"hljs-string\",\n            children: \"'entityManagerFactory'\"\n          }), \" ..\\n\"]\n        })\n      }), \"\\n\", _jsx(_components.p, {\n        children: \"Hikari CP 에서 몇 차례 연결 시도를 하고 실패하는 경우 entityManagerFactory 빈을 생성할 때 에러가 발생합니다.\"\n      }), \"\\n\", _jsx(_components.h2, {\n        children: \"서버 실행 중간에 DB 연결이 안되면\"\n      }), \"\\n\", _jsx(_components.p, {\n        children: \"테스트를 위해서 실행 중간에 DB 서버를 종료시켰습니다.\\n서버가 실행되는 중에 DB 연결이 끊기더라도 DB 연결이 필요한 요청이 오기 전까지 확인하지 않았습니다.\"\n      }), \"\\n\", _jsx(_components.pre, {\n        children: _jsxs(_components.code, {\n          className: \"hljs language-css\",\n          children: [\"HikariPool-\", _jsx(_components.span, {\n            className: \"hljs-number\",\n            children: \"1\"\n          }), \" - Failed \", _jsx(_components.span, {\n            className: \"hljs-selector-tag\",\n            children: \"to\"\n          }), \" validate connection com\", _jsx(_components.span, {\n            className: \"hljs-selector-class\",\n            children: \".mysql\"\n          }), _jsx(_components.span, {\n            className: \"hljs-selector-class\",\n            children: \".cj\"\n          }), _jsx(_components.span, {\n            className: \"hljs-selector-class\",\n            children: \".jdbc\"\n          }), _jsx(_components.span, {\n            className: \"hljs-selector-class\",\n            children: \".ConnectionImpl\"\n          }), _jsx(_components.span, {\n            className: \"hljs-keyword\",\n            children: \"@65ff8761\"\n          }), \"\\n(No operations allowed after connection closed.).\\nPossibly consider using a shorter maxLifetime value.\\n\"]\n        })\n      }), \"\\n\", _jsx(_components.p, {\n        children: \"연결이 다시 들어오면 DB 커넥션 풀에서 연결을 찾는 과정을 반복하고 로그를 남깁니다.\\nHikari Pool을 사용하는 경우 위와 같은 로그가 남게 됩니다.\\n로그 기록을 보면 실패하고 연결을 기간을 두고 10번을 시도한 것을 확인할 수 있었습니다.\"\n      }), \"\\n\", _jsx(_components.pre, {\n        children: _jsxs(_components.code, {\n          className: \"hljs language-csharp\",\n          children: [\"HikariPool\", _jsx(_components.span, {\n            className: \"hljs-number\",\n            children: \"-1\"\n          }), \" - Connection \", _jsx(_components.span, {\n            className: \"hljs-keyword\",\n            children: \"is\"\n          }), \" \", _jsx(_components.span, {\n            className: \"hljs-keyword\",\n            children: \"not\"\n          }), \" available, request timed \", _jsx(_components.span, {\n            className: \"hljs-keyword\",\n            children: \"out\"\n          }), \" after \", _jsx(_components.span, {\n            className: \"hljs-number\",\n            children: \"30000\"\n          }), \"ms.\\n\"]\n        })\n      }), \"\\n\", _jsx(_components.p, {\n        children: \"10번이 완료되고 나서 요청 시간이 30000ms 지나서 연결이 안된 것으로 판단한 것을 확인할 수 있습니다.\\n이때 나오는 30000ms 가 maxLifetime으로 필요에 따라 늘리거나 줄일 수 있습니다.\"\n      }), \"\\n\", _jsx(_components.pre, {\n        children: _jsxs(_components.code, {\n          className: \"hljs language-yaml\",\n          children: [_jsx(_components.span, {\n            className: \"hljs-attr\",\n            children: \"spring:\"\n          }), \"\\n    \", _jsx(_components.span, {\n            className: \"hljs-attr\",\n            children: \"datasource:\"\n          }), \"\\n        \", _jsx(_components.span, {\n            className: \"hljs-attr\",\n            children: \"hikari:\"\n          }), \"\\n            \", _jsx(_components.span, {\n            className: \"hljs-attr\",\n            children: \"maxLifetime:\"\n          }), \" \", _jsx(_components.span, {\n            className: \"hljs-number\",\n            children: \"30000\"\n          }), \"\\n\"]\n        })\n      }), \"\\n\", _jsx(_components.p, {\n        children: \"따로 설정하지 않아도 위에서 나온 기본값처럼 30000ms 가 설정됩니다.\\n중요한 점은 이때 지정하는 maxLifetime은 데이터베이스에 적용된 connection time limit 보다 작아야 합니다.\"\n      }), \"\\n\", _jsx(_components.pre, {\n        children: _jsxs(_components.code, {\n          className: \"hljs language-yaml\",\n          children: [_jsx(_components.span, {\n            className: \"hljs-attr\",\n            children: \"java.net.ConnectException: Connection refused:\"\n          }), \" \", _jsx(_components.span, {\n            className: \"hljs-literal\",\n            children: \"no\"\n          }), \" \", _jsx(_components.span, {\n            className: \"hljs-string\",\n            children: \"further\"\n          }), \" \", _jsx(_components.span, {\n            className: \"hljs-string\",\n            children: \"information\"\n          }), \"\\n\"]\n        })\n      }), \"\\n\", _jsx(_components.p, {\n        children: \"최종적으로 확인할 수 있는 에러는 ConnectionException으로 나오게 됩니다.\\n웹 요청이었다면 방금 거치는 DB 연결이 끊기는지 확인하는 시간까지 다 지난 후에 에러 응답이 나가게 됩니다.\"\n      })]\n    });\n  }\n}\nreturn {\n  default: MDXContent\n};\n","frontmatter":{},"scope":{}}},"__N_SSG":true},"page":"/posts/[id]","query":{"id":"Spring db 서버가 중단되면"},"buildId":"OHndlubwgpGIpyme6ZXhY","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>