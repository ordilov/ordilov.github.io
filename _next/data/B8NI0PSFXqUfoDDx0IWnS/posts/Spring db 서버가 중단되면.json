{"pageProps":{"metadata":{"title":"Spring DB 서버가 중단되면","date":"2022-04-01 00:00:01 +0900","category":"backend","tags":["backend"],"keywords":["backend"],"description":"Spring 서버 동작 중 DB와의 연결이 중단되었을 때를 알아봅니다.","id":"Spring db 서버가 중단되면"},"mdxSource":{"compiledSource":"/*@jsxRuntime automatic @jsxImportSource react*/\nconst {Fragment: _Fragment, jsx: _jsx, jsxs: _jsxs} = arguments[0];\nconst {useMDXComponents: _provideComponents} = arguments[0];\nfunction MDXContent(props = {}) {\n  const {wrapper: MDXLayout} = Object.assign({}, _provideComponents(), props.components);\n  return MDXLayout ? _jsx(MDXLayout, Object.assign({}, props, {\n    children: _jsx(_createMdxContent, {})\n  })) : _createMdxContent();\n  function _createMdxContent() {\n    const _components = Object.assign({\n      h2: \"h2\",\n      p: \"p\",\n      pre: \"pre\",\n      code: \"code\",\n      span: \"span\"\n    }, _provideComponents(), props.components);\n    return _jsxs(_Fragment, {\n      children: [_jsx(_components.h2, {\n        children: \"Spring 초기에 DB 연결이 안되면\"\n      }), \"\\n\", _jsx(_components.p, {\n        children: \"JPA와 Hikari CP를 사용하고 있는 경우 DB 서버와 연결이 안되는 경우 서버가 시작되지 않습니다.\"\n      }), \"\\n\", _jsx(_components.pre, {\n        children: _jsxs(_components.code, {\n          className: \"hljs language-javascript\",\n          children: [\" \", _jsx(_components.span, {\n            className: \"hljs-title class_\",\n            children: \"Error\"\n          }), \" creating bean \", _jsx(_components.span, {\n            className: \"hljs-keyword\",\n            children: \"with\"\n          }), \" name \", _jsx(_components.span, {\n            className: \"hljs-string\",\n            children: \"'entityManagerFactory'\"\n          }), \" ..\\n\"]\n        })\n      }), \"\\n\", _jsx(_components.p, {\n        children: \"Hikari CP 에서 몇 차례 연결 시도를 하고 실패하는 경우 entityManagerFactory 빈을 생성할 때 에러가 발생합니다.\"\n      }), \"\\n\", _jsx(_components.h2, {\n        children: \"서버 실행 중간에 DB 연결이 안되면\"\n      }), \"\\n\", _jsx(_components.p, {\n        children: \"테스트를 위해서 실행 중간에 DB 서버를 종료시켰습니다.\\n서버가 실행되는 중에 DB 연결이 끊기더라도 DB 연결이 필요한 요청이 오기 전까지 확인하지 않았습니다.\"\n      }), \"\\n\", _jsx(_components.pre, {\n        children: _jsxs(_components.code, {\n          className: \"hljs language-css\",\n          children: [\"HikariPool-\", _jsx(_components.span, {\n            className: \"hljs-number\",\n            children: \"1\"\n          }), \" - Failed \", _jsx(_components.span, {\n            className: \"hljs-selector-tag\",\n            children: \"to\"\n          }), \" validate connection com\", _jsx(_components.span, {\n            className: \"hljs-selector-class\",\n            children: \".mysql\"\n          }), _jsx(_components.span, {\n            className: \"hljs-selector-class\",\n            children: \".cj\"\n          }), _jsx(_components.span, {\n            className: \"hljs-selector-class\",\n            children: \".jdbc\"\n          }), _jsx(_components.span, {\n            className: \"hljs-selector-class\",\n            children: \".ConnectionImpl\"\n          }), _jsx(_components.span, {\n            className: \"hljs-keyword\",\n            children: \"@65ff8761\"\n          }), \"\\n(No operations allowed after connection closed.).\\nPossibly consider using a shorter maxLifetime value.\\n\"]\n        })\n      }), \"\\n\", _jsx(_components.p, {\n        children: \"연결이 다시 들어오면 DB 커넥션 풀에서 연결을 찾는 과정을 반복하고 로그를 남깁니다.\\nHikari Pool을 사용하는 경우 위와 같은 로그가 남게 됩니다.\\n로그 기록을 보면 실패하고 연결을 기간을 두고 10번을 시도한 것을 확인할 수 있었습니다.\"\n      }), \"\\n\", _jsx(_components.pre, {\n        children: _jsxs(_components.code, {\n          className: \"hljs language-csharp\",\n          children: [\"HikariPool\", _jsx(_components.span, {\n            className: \"hljs-number\",\n            children: \"-1\"\n          }), \" - Connection \", _jsx(_components.span, {\n            className: \"hljs-keyword\",\n            children: \"is\"\n          }), \" \", _jsx(_components.span, {\n            className: \"hljs-keyword\",\n            children: \"not\"\n          }), \" available, request timed \", _jsx(_components.span, {\n            className: \"hljs-keyword\",\n            children: \"out\"\n          }), \" after \", _jsx(_components.span, {\n            className: \"hljs-number\",\n            children: \"30000\"\n          }), \"ms.\\n\"]\n        })\n      }), \"\\n\", _jsx(_components.p, {\n        children: \"10번이 완료되고 나서 요청 시간이 30000ms 지나서 연결이 안된 것으로 판단한 것을 확인할 수 있습니다.\\n이때 나오는 30000ms 가 maxLifetime으로 필요에 따라 늘리거나 줄일 수 있습니다.\"\n      }), \"\\n\", _jsx(_components.pre, {\n        children: _jsxs(_components.code, {\n          className: \"hljs language-yaml\",\n          children: [_jsx(_components.span, {\n            className: \"hljs-attr\",\n            children: \"spring:\"\n          }), \"\\n    \", _jsx(_components.span, {\n            className: \"hljs-attr\",\n            children: \"datasource:\"\n          }), \"\\n        \", _jsx(_components.span, {\n            className: \"hljs-attr\",\n            children: \"hikari:\"\n          }), \"\\n            \", _jsx(_components.span, {\n            className: \"hljs-attr\",\n            children: \"maxLifetime:\"\n          }), \" \", _jsx(_components.span, {\n            className: \"hljs-number\",\n            children: \"30000\"\n          }), \"\\n\"]\n        })\n      }), \"\\n\", _jsx(_components.p, {\n        children: \"따로 설정하지 않아도 위에서 나온 기본값처럼 30000ms 가 설정됩니다.\\n중요한 점은 이때 지정하는 maxLifetime은 데이터베이스에 적용된 connection time limit 보다 작아야 합니다.\"\n      }), \"\\n\", _jsx(_components.pre, {\n        children: _jsxs(_components.code, {\n          className: \"hljs language-yaml\",\n          children: [_jsx(_components.span, {\n            className: \"hljs-attr\",\n            children: \"java.net.ConnectException: Connection refused:\"\n          }), \" \", _jsx(_components.span, {\n            className: \"hljs-literal\",\n            children: \"no\"\n          }), \" \", _jsx(_components.span, {\n            className: \"hljs-string\",\n            children: \"further\"\n          }), \" \", _jsx(_components.span, {\n            className: \"hljs-string\",\n            children: \"information\"\n          }), \"\\n\"]\n        })\n      }), \"\\n\", _jsx(_components.p, {\n        children: \"최종적으로 확인할 수 있는 에러는 ConnectionException으로 나오게 됩니다.\\n웹 요청이었다면 방금 거치는 DB 연결이 끊기는지 확인하는 시간까지 다 지난 후에 에러 응답이 나가게 됩니다.\"\n      })]\n    });\n  }\n}\nreturn {\n  default: MDXContent\n};\n","frontmatter":{},"scope":{}}},"__N_SSG":true}